# Change log
## 3.14.0
- The global replacements feature affects the auto_map.json file.
- Moved the code of the filter to a Python package: https://pypi.org/project/regolith-system-template/1.2.1/
- The default setting for `"systems"` `config.json` setting isn't `"**/*"` anymore. Now it's `"**"`. The paths of the systems are matched starting from the `system_template` folder (exclusive). Previously, the `system_template` string was included in the path pattern.

## 3.13.0
## New Features
- Added new `python_script` feature. Everything in `_map.py` can now be marked as a Python script. Python scripts are evaluated using Python's `exect()` before their output is passed to the regular system_template flow. The scripts are evaluated in the root of the system as their working directory, but have access to a `__target__` variable which is a `pathlib.Path` object with the evaluated absolute target path. If script doesn't define `__output__` variable, no file is created.
- Added option to define global `replacements` in the `config.json` file. The global replacements are applied to all systems.

## Changes
- Added `@` to the list of the available characters used in the `namespace` feature.

## Bug Fixes
Fixed the inconsistent switching of the working directory for files that use `json_template`. Every evaluated files (using `subfunctions`, `json_tempalte` or Python template) now have the working directory set to the system folder.

## 3.12.0
Added new `namespace` configuration option. This feature allows you to easily define the namespaces that should be used in the code generated by System Template. This is useful when you're working on Add-Ons and want to avoid name collisions. Internally, it's a simple search & replace operation, with some additional rules that make it especially useful in the context of Minecraft packs.

## 3.11.2
Updated the subfunctions module to be at least 1.2.3. It fixes a bug where
subfunctions could overwrite files using `definefunction`, `function`,
`schedule` and `functiontree`.

The bugfix in the `regolith-subfunctions` module will also affect new
installations of the filter, even if the version of the filter is not updated
due to the dependency versioning (previously ~=1.2).

## 3.11.1
Fixed the crashes from the `overwrite` `on_conflict` policy.

## 3.11.0
Added option to define the scope directly in the Regolith's `config.json` file, in the `filters` list of the profile. The values defined in the `config.json` file scope override the values defined in the scope provided through the file specified in the `scope_path` property.

## 3.10.2
Fixed exporting .py files to .py targets. System template doesn't try to evaluate these files anymore, just like it used to be before 3.10.0.

## 3.10.1
Added test for correct usage of json_template and subfunction properties in _map.py. Using them incorrectly will now raise an error, instead of silently skipping and exporting the files incorrectly.

## 3.10.0
### Directory export
The paths in `target` property in `_map.py` that end with a forward slash (`/`) are now interpreted as the directory paths. Using them, means that the file source file, should be exported to the directory specified in the `target` property. The file name is preserved. This is useful when you want to export multiple files to the same directory using the glob patterns, without using the AUTO mapping.

### The `replacements` property
Added `replacements` the property to the items in the `_map.py` list. The `replacements` is a dictionary which maps strings that should be replaced (keys) to their new values (values). Using `replacements` combined with `json.dumps()` can be useful for passing the data from scope into JS/TypeScript files. The `json` module has been added to the `_default_plugin.py` for this purpose.

## 3.9.0
Added option to specify the priritized systems in the filter settings in the `config.json` file using the `prioritized_systems` property.

## 3.8.1
Updated the `regolith-json-template` library to version 1.3.1.

Enables using the `Ellipsis` (`...`) in the lists.

## 3.8.0
Updated the `regolith-json-template` library to version 1.3.0.

When a value in a dictionary evaluates to `Ellipsis` (`...`), the key-value pair is removed from the dictionary. This can be used to conditionally remove keys from the dictionary.

## 3.7.0
- Added a new feature that lets you mark a file to be exported only once. The `export_once` flag in `_map.py` set to `True` means that if the same source file is being exported to the same target multipe times (e.g from different systems), the file is exported only once. This is useful when you want to export a shared file from multiple systems but you want to make sure that the target won't have duplicated content.
- More flexible AUTO mapping, lets you specify the directory mapping separately from the stem of the file (with `target->dir` and `target->stem` properties). This means that you can combine the AUTO mapping to detect the target directory and file extension, while still having the ability to set the custom name of the file. This is useful when you want to use a file as a template to generate multiple files with different names.
- Updated the format of the log file. Now the messages are more detailed. When the file is merged, the log distinguishes between the merge type (appending at the end, appending at the start, or merging). The log file also includes the information about the cause of skipping the file (skipping because of the `"on_conflict": "skip"` policy or skipping because of the `export_once` setting).

## 3.6.1
Updated the default auto_map.json file to export `.js` and `.ts` files into `data/system_template_esbuild` directory, intended for further processing with the `system_template_esbuild` filter.

## 3.6.0
Exporting to the `data/` folder is now supported. This should help System Tempalte cooperate with other filters.

## 3.5.0
Added new property available for the mapping objects - `file_type`. It overrides how the file is treated by the System Template filter pretending that the file is a different type of a file than its extension suggests. This is useful for integrating System Template with other filters that require using specific file types but use a syntax recognized by System Template. For example, when you want to write a JSON file with an extension that is not `.json` but still want to use the `json_template` filter to generate the file.

## 3.4.0
The `auto_map.json` file is now evaulated using JSON Tempalte, with the access to the global scope and global plugins. This means that the output paths can be dynamically generated based on the configuration of the project.

## 3.3.0
Updated the subfunctions module to 1.2.0. The same version that is used by the subfunctions filter version 2.1.0. This allows creating subfunctions from the 'schedule' command (you can check the 'subfunctions' filter's README for more information).

## 3.2.1
Added `.material` to the default `auto_map.json` file.

## 3.2.0
## Groups
The systems can now be groupped together in directories called groups.
- Any directory that contains a `_group_scope.json` file is considered a group.
- The `_group_scope.json` file can define variables that are visible to all systems in the group. During the evaluation of the system it is merged with the global and the system scope. It overrides the global scope and is overriden by the system scope.
- When using `AUTO_SUBFOLDER` or `AUTO_FLAT_SUBFOLDER` keywords, the name of the systems of the group is based on the path from the root of the group instead of the root of the project.
- Groups have their own `_shared` resources folders but the can also access the files in the global `_shared` folder.
- The `unpack` command for `reoglith apply-filter` unpacks the files to the `_shared` folder of the group instead of the global `_shared` folder.
- The `pack` command for `reoglith apply-filter` can pack the files from both of the `_shared` folders (global and group) into the system's data folder but the files from the group's `_shared` folder have priority over the files from the global `_shared` folder.
- Currently nested groups are not supported.

## File scanning improvements and changes
Fixed the bug that caused the filter to scan entire filter data folder looking for systems instead of scanning just the system template folder. This fix should also improve the performance on projects that are big enough to make walking files significant part of the execution time. Additionally, the function that scans the files won't go into the folders of the systems anymore. This means that the nested systems aren't supported anymore but in most cases it's a performance gain at the cost of supporting a rarely used feature that decreases readability of the project.

## 3.1.0
The "append_start" and "append_end" values of the "on_conflict" are not limited to the `.mcfunction` and `.lang` files anymore.

## 3.0.1
Fixed plugin functions not being able to call other plugin functions from their scope.

## 3.0.0

## Added plugins
The plugins are Python files stored in `_plugins` foler. There are two types of plugins:
- global plugins - stored in `<filters-data>/system_template/_plugins` folder. These are shared between all systems.
- local plugins - stored in `<filters-data>/system_tempalte/<system>/_plugins` folder. These are specific to the system.

Plugins are executed using `exec` function, and then their local scope is merged with the scope of the system. The order of execution of the plugins in the same folder is not defined (current implementation uses `pathlib.Path.glob`).

The priority of the data defined by plugins, and local and global scopes is as follows (things higher on the list are overriden by things lower on the list):
- global plugins
- global scope
- local plugins
- local scope

## Removed some of the default variables from the scope
The following variables are no longer defined in the default scope:
- `Path`
- `uuid`
- `math`
- `random`

They are added using a `_default_plugin.py` file from the `_plugins` folder available in the new default `data` folder.

> **WARNING:** If you're upgrading from a previous version, you need to add the `_default_plugin.py` file to your `_plugins` folder to get the same functionality as before.

## JSON files are only parsed when needed
Some of the JSON files of the systems are not parsed anymore and are treated as regular text files. This is done to improve the performance of the filter. The files are only evaluated when it's needed, that is:
- when they use the `"on_conflict": "merge"` option (so that their content can be merged with an existing file)
- when they use `"json_template": true` so that their content can be generated using the `regolith-json-template` library

## Updated the default `auto_map.json` file
The feature and feature rule now strip the `.feature` and `.feature_rule` suffixes from the file names when exported. This is done because the feature and feature rule files are required to have matching file names and identifiers.

## 2.9.1
Added missing `regolith-json-template` variables to the default scope.

## 2.9.0
Updated the `regolith-json-template` module to version `1.2.0`. This adds `JoinStr` feature and adds `random` module to the default scope. See the `README.md` file of the `json_template` filter for more information.

> **WARNING:** This version is missing the `JoinStr` feature. Use `2.9.1` instead.

## 2.8.0
Updated the `regolith-json-template` library to version `1.1.0` to unlock the `__unpack__` and `__value__` keys. See the `json_template` filter's `README.md` for more information.

## 2.7.0
- The auto_map.json file supports new mapping format. The values of the mapping can be a string (old format) or an object with the following properties:
  - `target` - the target path of the file (used for the same purpose as the string value in the old format)
  - `replace_extension` - the value to be used to replace the extension being mapped (optional)
- Updated the default `auto_map.json` file.
  - Added mapping for the `.<some suffix>.py` files into their coressponding json files (e.g. `.bp_ac.py` -> `.bp_ac.json`)
  - Added new mapping for the texture files using the new mapping format. The newly added texture mapping uses similar prefixes to the old mapping, but starting with a dot instead of an underscore. The old mapping is still present for backwards compatibility. Example:
    - Old: `_block.png` -> `_block.png` (still works)
    - New: `.block.png` -> `.png`
## 2.6.1
Fixed filter crashing on invalid JSON files instead of printing an error message with useful information.
## 2.6.0
Added `AUTO_FLAT` and `AUTO_FLAT_SUBFOLDER` keywords for new auto mapping.
## 2.5.0
Added `AUTO_SUBFOLDER` keyword that can be used with the "target" property of a system in `_map.py`. To automatically map the file to a path in RP or BP folder with the addition of a subfolder named after the path of the system.
## 2.4.1
- Fixed the issue of crashing when using `subfunctions` to create nested file structures.
- Fixed crashing when the `config.json` file is not defining the `log_path` property.
## 2.4.0
Added option to evaluate JSON files (`.json` or `.material`) with the
`json_template` regolith filter if explicitly specified in the `_map.py` file.
## 2.3.0
Added `pathlib.Path` to the default scope. The files are evaluated with the
working directory set to the system folder, which means that the `Path(".")`
points at the system folder to let you access the information about the files
in the system.
## 2.2.0
Added logging feature
## 2.1.0
- Added support for the shared resources stored in the `shared` folder. The
  shared resources can be annotated by adding `SHARED:` prefix in their source
  path.
- Updated `auto_map.json` in the data folder.
- Added `pack`, `unpack` and `undo` commands for
  `regolith apply-filter -- system_template`. To make working with shared
  resources easier.
## 2.0.2
Updated the `better-json-tools` dependency to `~=1.0.3`. It fixes epxorting the
JSON files with quotes inside the strings.
## 2.0.1
Updated `regolith-subfunctions` dependency to `~=1.1`. This allows using
comments in the `scope.json` file. For `mcfunction` and `lang` files
evaluation.
## 2.0.0
The `.lang` and `.mcfunction` files can be evaluated using the subfunctions
filter with the scope defined in the `_map.py` file.
## 1.2.0
- Added support for using glob patterns in the `_map.py` file for the source
files.
- The `.material` files are treated the same as the JSON files.
- Better error messages.
- Merging dictionaries (JSON files) preserves the order of the keys.
## 1.1.1
The filter uses the `CompactEncoder` from the `better_json_tools` package for
exporting the JSON files.
## 1.1.0
The scope files can use comments.
## 1.0.0
- renamed `system_scope.json` to `_scope.json`
- removed the `data` folder from the systems (everything is in the root)
- added `AUTO` keyword that can be used with the "target" property of a system in `_map.py`
- renamed `system_template.py` to `_map.py`
- removed `use_global_scope` property from the system configuration (enabled by default)
- improved README file
## Older versions
Older versions are not documented here. You can check the hisotry of the commit
messages.